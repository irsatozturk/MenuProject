@rendermode InteractiveServer
@using MenuProject.Admin.Components.Layout
@using MenuProject.Admin.Services

@inject ClientTranslationService Translate
@inject ToastService ToastService
@* ^^^ ARTIK SERVİSİ KULLANIYORUZ ^^^ *@

@implements IDisposable
@* ^^^ Bileşen kapanırken aboneliği iptal etmek için ^^^ *@

<div class="toast-container">
    @foreach (var msg in messages)
    {
        <div class="custom-toast @(msg.IsError ? "toast-error" : "toast-success") @(msg.IsFading ? "toast-fading" : "")">
            <strong>@(msg.IsError? Translate.Get("error_title") : Translate.Get("success_title"))</strong>
            <br />
            @msg.Text
        </div>
    }
</div>

@code {
    public class ToastMessage
    {
        public string Text { get; set; } = "";
        public bool IsError { get; set; }
        public bool IsFading { get; set; }
    }

    private List<ToastMessage> messages = new();

    protected override void OnInitialized()
    {
        // SERVİSE ABONE OLUYORUZ:
        // "Biri ShowToast derse, benim Show metodumu çalıştır"
        ToastService.OnShow += Show;
    }

    private void Show(string text, bool isError)
    {
        // Bu metot arka plandaki servisten tetiklendiği için
        // arayüzü (UI) güncellemek için InvokeAsync kullanmalıyız.
        InvokeAsync(() =>
        {
            var msg = new ToastMessage { Text = text, IsError = isError };
            messages.Add(msg);
            StateHasChanged();

            Task.Run(async () =>
            {
                await Task.Delay(4000);
                msg.IsFading = true;
                await InvokeAsync(StateHasChanged);

                await Task.Delay(1000);
                messages.Remove(msg);
                await InvokeAsync(StateHasChanged);
            });
        });
    }

    public void Dispose()
    {
        // Hafıza sızıntısını önlemek için aboneliği iptal et
        ToastService.OnShow -= Show;
    }
}