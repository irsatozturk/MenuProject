@page "/menus/create"
@rendermode InteractiveServer
@using MenuProject.Shared.Models
@using MenuProject.Admin.Services
@using MenuProject.Admin.Components.Layout @* MainLayout'a erişim için *@

@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavManager
@* 1. Çeviri Servisini Enjekte Et *@
@inject ClientTranslationService Translate

@* 3. İSTEK: Başlıklar artık veritabanından geliyor *@
<h3>@Translate.Get("menu_create_title")</h3>

@if (isLoading)
{
    <div class="alert alert-info">Yükleniyor...</div>
}
else
{
    <EditForm Model="@menu" OnValidSubmit="HandleSubmit" FormName="CreateMenuForm">
        <DataAnnotationsValidator />

        @* validation summary yerine artık Toast kullanacağız *@

        <div class="card mb-3">
            <div class="card-header">@Translate.Get("menu_name_label")</div>
            <div class="card-body">
                @foreach (var translation in menu.Translations)
                {
                    <div class="mb-3">
                        <label class="form-label">
                            @Translate.Get("menu_name_label") (@translation.LanguageCode.ToUpper())
                            @if (translation.LanguageCode == defaultLang)
                            {
                                <span class="text-primary fw-bold ms-2">(*)</span>
                            }
                        </label>

                        <InputText @bind-Value="translation.Name" class="form-control" />
                    </div>
                }
            </div>
        </div>

        <div class="mb-3 form-check">
            <label class="form-check-label">
                <InputCheckbox @bind-Value="menu.IsActive" class="form-check-input" />
                @Translate.Get("is_active")
            </label>
        </div>

        <div class="mb-3 form-check">
            <label class="form-check-label">
                <InputCheckbox @bind-Value="menu.IsDefault" class="form-check-input" />
                @Translate.Get("is_default")
            </label>
        </div>

        <button type="submit" class="btn btn-success">@Translate.Get("save_btn")</button>
        <a href="/menus" class="btn btn-secondary">@Translate.Get("cancel_btn")</a>
    </EditForm>
}

@code {
    private Menu menu = new Menu();
    private bool isLoading = true;
    private string defaultLang = "tr";

    protected override async Task OnInitializedAsync()
    {
        // 1. Önce Çevirileri Yükle (Bu çok hızlı olur)
        await Translate.LoadTranslationsAsync("tr"); // Varsayılan dil TR olsun

        var client = HttpClientFactory.CreateClient("MenuAPI");
        try
        {
            var settings = await client.GetFromJsonAsync<LanguageSettingsDto>("/api/Menu/Languages");

            if (settings != null)
            {
                defaultLang = settings.DefaultLanguage;
                foreach (var langCode in settings.SupportedLanguages)
                {
                    menu.Translations.Add(new MenuTranslation { LanguageCode = langCode, Name = "" });
                }
            }
        }
        catch (Exception ex)
        {
            // 2. İSTEK: Eski Console.WriteLine yerine Toast kullan
            MainLayout.GlobalNotifier?.Show($"Sistem Hatası: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        // 1. Validasyon Kontrolü
        var defaultTranslation = menu.Translations.FirstOrDefault(t => t.LanguageCode == defaultLang);
        if (defaultTranslation == null || string.IsNullOrWhiteSpace(defaultTranslation.Name))
        {
            // 1. İSTEK: Popup (Toast) olarak hata göster
            MainLayout.GlobalNotifier?.Show(Translate.Get("validation_error"), true);
            return;
        }

        var client = HttpClientFactory.CreateClient("MenuAPI");

        try
        {
            var response = await client.PostAsJsonAsync("/api/Menu", menu);

            if (response.IsSuccessStatusCode)
            {
                // 1. İSTEK: Başarı mesajı (Yeşil)
                MainLayout.GlobalNotifier?.Show(Translate.Get("save_success"), false);

                // Biraz bekleyip yönlendir (Mesaj görünsün diye)
                await Task.Delay(1000);
                NavManager.NavigateTo("/menus");
            }
            else
            {
                // Hata Mesajı (Kırmızı)
                MainLayout.GlobalNotifier?.Show($"{Translate.Get("api_error")} ({response.StatusCode})", true);
            }
        }
        catch (Exception ex)
        {
            MainLayout.GlobalNotifier?.Show(ex.Message, true);
        }
    }
}