@page "/menus/create"
@rendermode InteractiveServer
@using MenuProject.Shared.Models
@using MenuProject.Admin.Services
@using MenuProject.Admin.Components.Layout

@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavManager
@inject ClientTranslationService Translate
@inject NotifierService Notifier

<h3>@Translate.Get("menu_create_title")</h3>

@if (isLoading)
{
    <div class="alert alert-info">Yükleniyor...</div>
}
else
{
    <EditForm Model="@menu" OnValidSubmit="HandleSubmit" FormName="CreateMenuForm">
        <DataAnnotationsValidator />

        <div class="card mb-3">
            <div class="card-header">@Translate.Get("menu_name_label")</div>
            <div class="card-body">
                @foreach (var translation in menu.Translations)
                {
                    <div class="mb-3">
                        <label class="form-label">
                            @Translate.Get("menu_name_label") (@translation.LanguageCode.ToUpper())
                            @if (translation.LanguageCode == defaultLang)
                            {
                                <span class="text-primary fw-bold ms-2">(*)</span>
                            }
                        </label>
                        <InputText @bind-Value="translation.Name" class="form-control" />
                    </div>
                }
            </div>
        </div>

        @* --- DÜZELTİLEN KISIM: @bind-Value:after KULLANIMI --- *@
        <div class="mb-3 form-check">
            <label class="form-check-label">
                @* IsDefault true ise bu kutu disabled (pasif) olur *@
                <InputCheckbox @bind-Value="menu.IsActive"
                               @bind-Value:after="OnActiveChanged"
                               class="form-check-input"
                               disabled="@menu.IsDefault" />
                @Translate.Get("is_active")
            </label>
        </div>

        <div class="mb-3 form-check">
            <label class="form-check-label">
                <InputCheckbox @bind-Value="menu.IsDefault"
                               @bind-Value:after="OnDefaultChanged"
                               class="form-check-input" />
                @Translate.Get("is_default")
            </label>
        </div>
        @* ----------------------------------------------------- *@

        <button type="submit" class="btn btn-success">@Translate.Get("save_btn")</button>
        <a href="/menus" class="btn btn-secondary">@Translate.Get("cancel_btn")</a>
    </EditForm>
}

@code {
    private Menu menu = new Menu();
    private bool isLoading = true;
    private string defaultLang = "tr";

    protected override async Task OnInitializedAsync()
    {
        await Translate.LoadTranslationsAsync("tr");
        var client = HttpClientFactory.CreateClient("MenuAPI");
        try
        {
            var settings = await client.GetFromJsonAsync<LanguageSettingsDto>("/api/Menu/Languages");
            if (settings != null)
            {
                defaultLang = settings.DefaultLanguage;
                foreach (var langCode in settings.SupportedLanguages)
                {
                    menu.Translations.Add(new MenuTranslation { LanguageCode = langCode, Name = "" });
                }
            }
        }
        catch (Exception ex)
        {
            Notifier.Show($"Sistem Hatası: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        var defaultTranslation = menu.Translations.FirstOrDefault(t => t.LanguageCode == defaultLang);
        if (defaultTranslation == null || string.IsNullOrWhiteSpace(defaultTranslation.Name))
        {
            Notifier.Show(Translate.Get("validation_error"), true);
            return;
        }

        var client = HttpClientFactory.CreateClient("MenuAPI");
        try
        {
            var response = await client.PostAsJsonAsync("/api/Menu", menu);

            if (response.IsSuccessStatusCode)
            {
                Notifier.Show(Translate.Get("save_success"), false);
                await Task.Delay(1000);
                NavManager.NavigateTo("/menus");
            }
            else
            {
                Notifier.Show($"{Translate.Get("api_error")} ({response.StatusCode})", true);
            }
        }
        catch (Exception ex)
        {
            Notifier.Show(ex.Message, true);
        }
    }

    // --- YENİ METOTLAR (PARAMETRESİZ) ---
    // ChangeEventArgs kullanmıyoruz, çünkü bind-Value veriyi zaten güncelledi.
    // Biz sadece 'sonra' (after) ne olacağına bakıyoruz.

    private void OnDefaultChanged()
    {
        if (menu.IsDefault)
        {
            menu.IsActive = true;
        }
    }

    private void OnActiveChanged()
    {
        if (menu.IsDefault)
        {
            menu.IsActive = true;
        }
    }
}