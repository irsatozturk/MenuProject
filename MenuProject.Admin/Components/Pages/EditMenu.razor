@page "/menus/edit/{Id:int}"
@rendermode InteractiveServer

@using MenuProject.Shared.Models
@using System.Net.Http.Json
@using MenuProject.Admin.Services
@using MenuProject.Admin.Components.Layout

@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavManager
@inject ClientTranslationService Translate
@inject NotifierService Notifier

<h3>@Translate.Get("menu_edit_title")</h3>

@if (isLoading)
{
    <div class="alert alert-info">@Translate.Get("loading")</div>
}
else
{
    <EditForm Model="@menu" OnValidSubmit="HandleSubmit" FormName="EditMenuForm">
        <DataAnnotationsValidator />

        <div class="card mb-3">
            <div class="card-header">@Translate.Get("menu_names_header")</div>
            <div class="card-body">
                @foreach (var translation in menu.Translations)
                {
                    <div class="mb-3">
                        <label class="form-label">
                            @translation.LanguageCode.ToUpper()
                            @if (translation.LanguageCode == defaultLang)
                            {
                                <span class="text-primary fw-bold ms-2">(*)</span>
                            }
                        </label>
                        <InputText @bind-Value="translation.Name" class="form-control" />
                    </div>
                }
            </div>
        </div>

        @* --- GÜNCELLENEN KISIM --- *@
        <div class="mb-3 form-check">
            <label class="form-check-label">
                <InputCheckbox @bind-Value="menu.IsActive"
                               @bind-Value:after="OnActiveChanged"
                               class="form-check-input"
                               disabled="@menu.IsDefault" />
                @Translate.Get("is_active")
            </label>
        </div>

        <div class="mb-3 form-check">
            <label class="form-check-label">
                <InputCheckbox @bind-Value="menu.IsDefault"
                               @bind-Value:after="OnDefaultChanged"
                               class="form-check-input" />
                @Translate.Get("is_default")
            </label>
        </div>
        @* ------------------------- *@

        <button type="submit" class="btn btn-warning">@Translate.Get("update_btn")</button>
        <a href="/menus" class="btn btn-secondary">@Translate.Get("cancel_btn")</a>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    private Menu menu = new Menu();
    private bool isLoading = true;
    private string defaultLang = "tr";

    protected override async Task OnInitializedAsync()
    {
        await Translate.LoadTranslationsAsync("tr");
        var client = HttpClientFactory.CreateClient("MenuAPI");
        try
        {
            var settings = await client.GetFromJsonAsync<LanguageSettingsDto>("/api/Menu/Languages");
            if (settings != null) defaultLang = settings.DefaultLanguage;

            var existingMenu = await client.GetFromJsonAsync<Menu>($"/api/Menu/{Id}");

            if (existingMenu != null)
            {
                menu = existingMenu;
                if (settings != null)
                {
                    foreach (var lang in settings.SupportedLanguages)
                    {
                        if (!menu.Translations.Any(t => t.LanguageCode == lang))
                        {
                            menu.Translations.Add(new MenuTranslation { LanguageCode = lang, Name = "", MenuId = menu.Id });
                        }
                    }
                }
            }
            else
            {
                Notifier.Show(Translate.Get("menu_not_found"), true);
                NavManager.NavigateTo("/menus");
            }
        }
        catch (Exception ex)
        {
            Notifier.Show($"Sistem Hatası: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        var client = HttpClientFactory.CreateClient("MenuAPI");
        try
        {
            var response = await client.PutAsJsonAsync("/api/Menu", menu);

            if (response.IsSuccessStatusCode)
            {
                Notifier.Show(Translate.Get("update_success"), false);
                await Task.Delay(1000);
                NavManager.NavigateTo("/menus");
            }
            else
            {
                Notifier.Show($"{Translate.Get("update_error")} ({response.StatusCode})", true);
            }
        }
        catch (Exception ex)
        {
            Notifier.Show(ex.Message, true);
        }
    }

    // --- PARAMETRESİZ METOTLAR ---
    private void OnDefaultChanged()
    {
        if (menu.IsDefault)
        {
            menu.IsActive = true;
        }
    }

    private void OnActiveChanged()
    {
        if (menu.IsDefault)
        {
            menu.IsActive = true;
        }
    }
}